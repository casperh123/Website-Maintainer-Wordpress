@page "/enhance-maintenance"
@using WebsiteMaintainer.Core.Entities
@using Microsoft.AspNetCore.Authorization
@using WebsiteMaintainer.Web.Components.Cards
@using WebsiteMaintainer.Web.Components.SiteSelectors
@using WebsiteMaintainer.Core.Repository
@using WebsiteMaintainer.Infrastructure.Services
@using WebsiteMaintainer.Web.Components.Button
@using WebsiteMaintainer.Web.Services
@inject IWebsiteRepository WebsiteRepository
@inject IEnhanceService EnhanceService
@inject IUserService UserService

@attribute [Authorize]

<RadzenStack Gap="20px">
    <RadzenText TextStyle="TextStyle.H1">Enhance Websites</RadzenText>

    <RadzenText TextStyle="TextStyle.H2" >
        <RadzenHeading >Websites</RadzenHeading>
        
        <ToggleButton @bind-Value="_addWebsites" Disabled="!_websites.Any()" OnText="Close" OffText="Add Websites"></ToggleButton>
    </RadzenText>
    
    @if (_addWebsites)
    {
        <EnhanceSiteSelector ExistingWebsites="_websites" EnhanceWebsites="_enhanceWebsites" WebsiteAdded="@WebsiteChanged"/>
    }
    
    <RadzenStack Gap="10px" Orientation="Orientation.Vertical">
        @if (_websites == null)
        {
            <p>Loading websites...</p>
        }
        else if(!_websites.Any())
        {
            <p>No websites are saved</p>
        }
        else
        {
            @foreach (Website website in _websites)
            {
                <WebsiteCard Website="@website" WebsiteChanged="@WebsiteChanged"/>
            }
        }
    </RadzenStack>
</RadzenStack>

@code {
    private List<Website> _websites;
    private List<Website> _enhanceWebsites;
    private bool _addWebsites;
    
    protected override async Task OnInitializedAsync()
    {
        ApplicationUser user = await UserService.GetCurrentUserAsync();
        _websites = await WebsiteRepository.GetAllAsync();
        _enhanceWebsites = await EnhanceService.GetWebsites(user);
        _addWebsites = !_websites.Any();
    }

    private async Task WebsiteChanged(Website website)
    {
        if (website.MaintenanceType is MaintenanceType.None)
        {
            await WebsiteRepository.Delete(website);
            _websites.Remove(website);
        }
        else
        {
            await WebsiteRepository.AddOrUpdate(website);
            
            if (!_websites.Contains(website))
            {
                _websites.Add(website);
            }
        }

        if (!_websites.Any())
        {
            _addWebsites = true;
        }
    }
}